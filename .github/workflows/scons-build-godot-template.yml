name: "scons build slimmed godot template"
on:
  push:
    branches: [ scons-build ]
  workflow_dispatch:

env:
  SCONSFLAGS: verbose=yes warnings=extra werror=yes debug_symbols=no tools=no mono_prefix=$HOME/mono-installs/wasm-runtime-release/
  EM_VERSION: 3.1.18
  EM_CACHE_FOLDER: "emsdk-cache"
  EMSCRIPTEN_ROOT: ~/.emscripten
jobs:
  build:
    name: Export
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          lfs: true
      - name: Set up build deps
        run: |
          sudo apt-get install build-essential scons pkg-config libx11-dev libxcursor-dev libxinerama-dev libglu-dev libasound2-dev libpulse-dev libfreetype6-dev libssl-dev libudev-dev libxrandr-dev
          sudo apt-get install libxi-dev
      - name: Set up Emscripten latest
        uses: mymindstorm/setup-emsdk@v12
        with:
          version: ${{env.EM_VERSION}}
          actions-cache-folder: ${{env.EM_CACHE_FOLDER}}

      - name: Verify Emscripten setup
        run: |
          emcc -v
          ln -s emsdk-cache/emsdk-main/.emscripten ~/.emscripten
          ls ~/
          cat ~/.emscripten
          
      - name: 🐍 Set up Python 3.x
        uses: actions/setup-python@v4
        with:
          # Semantic version range syntax or exact version of a Python version
          python-version: ${{ inputs.python-version }}
          # Optional - x64 or x86 architecture, defaults to x64
          architecture: ${{ inputs.python-arch }}
      - name: Get release info
        uses: actions/github-script@v6
        id: release_info
        with:
          script: |
            return (await (await fetch("https://api.github.com/repos/godotengine/godot-mono-builds/releases")).json())[0].assets
          result-encoding: json
          
      - name: Get linux assets browser url
        uses: actions/github-script@v6
        id: linux_url
        with:
          script: |
            const releaseInfo = ${{ steps.release_info.outputs.result }}
            const assetUrl = releaseInfo.find(({name}) => name === "linux-x86_64.zip").url
            const assetJson = await (await fetch(assetUrl)).json()
            return assetJson.browser_download_url
          result-encoding: string
      - uses: actions/github-script@v6
        id: wasm_url
        with:
          script: |
            const releaseInfo = ${{ steps.release_info.outputs.result }}
            const assetUrl = releaseInfo.find(({name}) => name === "wasm-runtime.zip").url
            const assetJson = await (await fetch(assetUrl)).json()
            return assetJson.browser_download_url
          result-encoding: string
      - name: Download godot mono installs
        run: |
          wget -O ~/linux-x86_64.zip ${{ steps.linux_url.outputs.result }}
          sudo unzip -d /root/mono-installs ~/linux-x86_64.zip
      - name: Set up mono
        run: |
          git clone -b mono-6.12.0.198 https://github.com/mono/mono
          export MONO_SOURCE_ROOT=$PWD/mono
          git clone https://github.com/godotengine/godot-mono-builds
          cd godot-mono-builds
          ./wasm.py configure --target=runtime
          ./wasm.py make --target=runtime
      - name: Clone godot 3.5
        run: |
         git clone -b 3.5 https://github.com/godotengine/godot.git godot --single-branch
          cd godot
      - name: Setup scons
        shell: bash
        run: |
          python -c "import sys; print(sys.version)"
          python -m pip install scons==4.4.0
          scons --version
        
      - name: Link mono installation to where Godot wants it
        run: |
          sudo ln -s /lib/mono/4.5 /root/mono-installs/desktop-linux-x86_64-release/lib/mono
        
      - name: Download Godot 3.5 & create glue
        run: |
          wget https://github.com/godotengine/godot/releases/download/3.5.1-stable/Godot_v3.5.1-stable_mono_linux_headless_64.zip
          unzip -d . Godot_v3.5.1-stable_mono_linux_headless_64.zip
          cd Godot_v3.5.1-stable_mono_linux_headless_64
          chmod +x Godot_v3.5.1-stable_mono_linux_headless.64
          cp Godot_v3.5.1-stable_mono_linux_headless.64 ../godot/
          cd ../godot/
          sudo ./Godot_v3.5.1-stable_mono_linux_headless.64 --generate-mono-glue ./modules/mono/glue

      - name: Scons Build godot template
        env:
            SCONSFLAGS: ${{ env.SCONSFLAGS }}
            SCONS_CACHE: ${{ inputs.scons-cache }}
            SCONS_CACHE_LIMIT: ${{ inputs.scons-cache-limit }}
        run: |
          export SCONS_CACHE="${{ github.workspace }}/.scons-cache/"
          mv custom.py godot/
          cd godot/
          echo "Building with flags:" platform=javascript target=release tests=false ${{ env.SCONSFLAGS }}
          if [ "${{ inputs.target }}" != "editor" ]; then rm -rf editor; fi  # Ensure we don't include editor code.
          scons profile=custom.py platform=javascript target=release tests=false ${{ env.SCONSFLAGS }}
          ls -l bin/
